<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Current Season Player ELOs</title>
    <link rel="stylesheet" href="/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <h1>Current Season Player ELOs</h1>
    <div id="feedback"></div>

    <div id="chartContainer">
      <canvas id="eloChart"></canvas>
    </div>

    <script>
      async function getActiveSeasonId() {
        const res = await fetch("/api/seasons");
        if (!res.ok) throw new Error("Failed to load seasons");
        const seasons = await res.json();
        const active = seasons.find((s) => s.isActive);
        if (!active) throw new Error("No active season found");
        return active._id;
      }

      async function fetchPlayerEloData(seasonId) {
        const pipeline = [
          { $match: { seasonId } },
          {
            $lookup: {
              from: "Player",
              localField: "playerId",
              foreignField: "_id",
              as: "player",
            },
          },
          { $unwind: "$player" },
          {
            $project: {
              _id: 0,
              latestIGN: "$player.latestIGN",
              elo: 1,
            },
          },
        ];

        const res = await fetch("/api/custom-query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            collection: "PlayerStats",
            pipeline: [
              { $match: { seasonId } },
              {
                $lookup: {
                  from: "Player",
                  localField: "playerId",
                  foreignField: "_id",
                  as: "player",
                },
              },
              { $unwind: "$player" },
              {
                $project: {
                  _id: 0,
                  latestIGN: "$player.latestIGN",
                  elo: 1,
                },
              },
            ],
          }),
        });
        if (!res.ok) throw new Error("Failed to load player stats");
        return res.json();
      }

      async function renderDistribution() {
        try {
          const seasonId = await getActiveSeasonId();
          const raw    = await fetchPlayerEloData(seasonId);
          const elos   = raw.map(d => d.elo);

          const binCount = Math.ceil(Math.sqrt(elos.length));
          const minVal   = Math.min(...elos);
          const maxVal   = Math.max(...elos);
          const binSize  = (maxVal - minVal) / binCount;

          const bins = Array.from({ length: binCount }, (_, i) => ({
            x: minVal + binSize * (i + 0.5),
            y: 0
          }));
          elos.forEach(v => {
            let idx = Math.floor((v - minVal) / binSize);
            if (idx === binCount) idx = binCount - 1;
            bins[idx].y++;
          });

          const mean = elos.reduce((s, v) => s + v, 0) / elos.length;
          const std  = Math.sqrt(elos.reduce((s, v) => s + (v - mean)**2, 0) / elos.length);
          const curvePoints = 100;
          const pdfScale = elos.length * binSize;
          const normalData = Array.from({ length: curvePoints }, (_, i) => {
            const x = minVal + (i / (curvePoints - 1)) * (maxVal - minVal);
            const pdf = (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * ((x - mean) / std) ** 2);
            return { x, y: pdf * pdfScale };
          });

          const scatterData = elos.map(v => ({ x: v, y: 0 }));

          const canvas = document.getElementById('eloChart');
          const ctx = canvas.getContext('2d');
          new Chart(ctx, {
            data: {
              datasets: [
                {
                  type: 'bar',
                  label: 'Histogram',
                  data: bins,
                  backgroundColor: 'rgba(0, 123, 255, 0.5)'
                },
                {
                  type: 'line',
                  label: 'Normal Curve',
                  data: normalData,
                  borderColor: 'rgba(255, 99, 132, 1)',
                  borderWidth: 2,
                  fill: false,
                  tension: 0.4
                },
                {
                  type: 'scatter',
                  label: 'Players',
                  data: scatterData,
                  pointBackgroundColor: 'yellow',
                  pointRadius: 5
                }
              ]
            },
            options: {
              scales: {
                x: {
                  type: 'linear',
                  title: { display: true, text: 'ELO Rating' }
                },
                y: {
                  beginAtZero: true,
                  title: { display: true, text: 'Count' }
                }
              },
              plugins: {
                legend: { position: 'top' }
              }
            }
          });
        } catch (e) {
          document.getElementById('feedback').innerText = e.message;
          console.error(e);
        }
      }

      document.addEventListener('DOMContentLoaded', renderDistribution);
    </script>
  </body>
</html>
