<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player Count Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
      body {
        background-color: #121212;
        color: #e0e0e0;
        font-family: "Roboto", sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .container {
        width: 90%;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }
      h1,
      h2 {
        text-align: center;
      }
      form {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        align-items: center;
      }
      form > div {
        display: flex;
        align-items: center;
      }
      label {
        margin-right: 5px;
        font-size: 1rem;
      }
      input[type="date"],
      input[type="date"] {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 4px;
        padding: 8px;
        color: #e0e0e0;
      }
      button {
        background-color: #1976d2;
        border: none;
        border-radius: 4px;
        padding: 10px 20px;
        font-size: 1rem;
        color: #fff;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #1565c0;
      }
      #dataPoints {
        margin-bottom: 20px;
        text-align: center;
      }
      #dataPoints label {
        margin-right: 15px;
        display: inline-block;
        margin-bottom: 5px;
      }
      #untickAllButton {
        margin-top: 10px;
        background-color: #dc3545;
      }
      canvas {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 4px;
        display: block;
        width: 100%;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Player Count Graph</h1>
      <form id="timeRangeForm">
        <div>
          <label for="start">Start:</label>
          <input type="date" id="start" name="start" />
        </div>
        <div>
          <label for="end">End:</label>
          <input type="date" id="end" name="end" />
        </div>
        <div>
          <button type="submit">Load Data</button>
        </div>
      </form>
      <div id="dataPoints">
        <h2>Select Data Points:</h2>
        <label
          ><input type="checkbox" name="datapoint" value="all" checked />
          All</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="all_us" checked /> All
          US</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="all_eu" checked /> All
          EU</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="annihilation"
            checked
          />
          Annihilation</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="annihilation_annilobby"
            checked
          />
          Annihilation Annilobby</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="annihilation_chill"
            checked
          />
          Annihilation Chill</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="annihilation_dev"
            checked
          />
          Annihilation Dev</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="annihilation_us"
            checked
          />
          Annihilation US</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="assault" checked />
          Assault</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="civwar" checked />
          Civwar</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="craftybomber"
            checked
          />
          Craftybomber</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="dbv" checked />
          DBV</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="dbv_dev" checked />
          DBV Dev</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="dbv_us" checked /> DBV
          US</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="ddg" checked />
          DDG</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="flappy" checked />
          Flappy</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="gg" checked />
          GG</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="gg_us" checked /> GG
          US</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="ghostcraft" checked />
          Ghostcraft</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="goldrush" checked />
          Goldrush</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="hcfactions" checked />
          HCFactions</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="hips" checked />
          Hips</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="lightbikes" checked />
          Lightbikes</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="lms" checked />
          LMS</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="lobby" checked />
          Lobby</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="lobby_lobby"
            checked
          />
          Lobby Lobby</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="lobby_us" checked />
          Lobby US</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="mama" checked />
          Mama</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="minerproblems"
            checked
          />
          Minerproblems</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="minerproblems_dev"
            checked
          />
          Minerproblems Dev</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="minez" checked />
          Minez</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="minez2" checked />
          Minez2</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="minez_dev" checked />
          Minez Dev</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="minez_minezlobby"
            checked
          />
          Minez Minezlobby</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="minez_us" checked />
          Minez US</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="mta" checked />
          MTA</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="shotball" checked />
          Shotball</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="slaughter" checked />
          Slaughter</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="slaughter_dev"
            checked
          />
          Slaughter Dev</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="slaughter_us"
            checked
          />
          Slaughter US</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="smash" checked />
          Smash</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="smash_us" checked />
          Smash US</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="sweepers" checked />
          Sweepers</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="vadact" checked />
          Vadact</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="warband" checked />
          Warband</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="wasted" checked />
          Wasted</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="wasted_control"
            checked
          />
          Wasted Control</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="wasted_gungame"
            checked
          />
          Wasted Gungame</label
        >
        <label
          ><input
            type="checkbox"
            name="datapoint"
            value="wasted_sandbox"
            checked
          />
          Wasted Sandbox</label
        >
        <label
          ><input type="checkbox" name="datapoint" value="wir" checked />
          Wir</label
        >
        <br />
        <button id="untickAllButton" type="button">Untick All</button>
      </div>
      <canvas id="playerCountChart"></canvas>
    </div>
    <script>
      const API_URL="/api/playerCount"; // fixed
      let chart,lastPayload;
      const qs=id=>document.getElementById(id);
      const qsa=(sel,root=document)=>Array.from(root.querySelectorAll(sel));
      const toDateInput=iso=>{const d=new Date(iso);const p=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`};
      const seriesColor=i=>`hsl(${(i*53)%360} 70% 60%)`;

      async function loadCounts({start,end}={}) {
        const params=new URLSearchParams();
        if(start) params.set("start",start);
        if(end) params.set("end",end);
        const url=params.size?`${API_URL}?${params}`:API_URL;
        const res=await fetch(url);
        if(!res.ok){throw new Error(`HTTP ${res.status}: ${await res.text().catch(()=> "")}`)}
        const json=await res.json();
        console.debug("payload.meta",json?.meta);
        console.debug("sample datum",json?.data?.[0]);
        return json;
      }

      function getSelectedKeys(){return new Set(qsa('input[name="datapoint"]:checked').map(i=>i.value));}

      function detectSeriesKeys(data){
        const s=data?.[0]||{};
        // support nested {counts:{...}} OR flat metrics
        const nested=typeof s.counts==="object" && s.counts!==null ? Object.keys(s.counts) : [];
        const flat=Object.keys(s).filter(k=>k!=="timestamp" && typeof s[k]==="number");
        const keys=[...new Set([...nested,...flat])];
        console.debug("detected keys",keys);
        return keys;
      }

      function valueFor(d,k){
        if(d.counts && typeof d.counts==="object" && k in d.counts) return Number(d.counts[k]);
        return Number(d[k]);
      }

      function buildDatasets(payload, selected){
        const {meta,data}=payload;
        const keys=detectSeriesKeys(data);
        // fallback: single "count"
        if(keys.length===0 && data?.length && Number.isFinite(Number(data[0]?.count))){
          return [{label:"Players",data:data.map(d=>({x:new Date(d.timestamp),y:+d.count})),borderWidth:1,pointRadius:meta.aggregated?2:0,borderColor:seriesColor(0)}];
        }
        let wanted=keys.filter(k=>selected.size===0 || selected.has(k));
        if(wanted.length===0) { // no checkbox match → plot everything found
          console.warn("No checkbox matched available series. Falling back to all keys.",{available:keys});
          wanted=keys;
        }
        return wanted.map((k,i)=>({
          label:k,
          data:data.map(d=>({x:new Date(d.timestamp),y:valueFor(d,k) || 0})),
          borderWidth:1,
          pointRadius:meta.aggregated?2:0,
          borderColor:seriesColor(i)
        }));
      }

      function renderChart(payload){
        lastPayload=payload;
        const {meta}=payload;
        const canvas=qs("playerCountChart");
        const ctx=canvas.getContext("2d");
        if(chart) chart.destroy();

        const datasets=buildDatasets(payload,getSelectedKeys());
        if(!datasets.length){ console.warn("No datasets to render."); }

        chart=new Chart(ctx,{
          type:"line",
          data:{datasets},
          options:{
            parsing:false,
            animation:false,
            normalized:true,
            spanGaps:true,
            plugins:{legend:{display:true},decimation:{enabled:true,algorithm:"lttb",samples:1200}},
            scales:{
              x:{type:"time",time:{unit:meta.aggregated?"day":"hour",round:meta.aggregated?"day":"minute"}},
              y:{beginAtZero:true}
            }
          }
        });

        if(qs("metaInfo")){
          qs("metaInfo").textContent=`${meta.granularity.toUpperCase()} • ${toDateInput(meta.start)} → ${toDateInput(meta.end)} • ${meta.points} pts`;
        }
        if(!qs("start").value) qs("start").value=toDateInput(meta.start);
        if(!qs("end").value) qs("end").value=toDateInput(meta.end);
      }

      function refreshFromSelections(){ if(!lastPayload) return; renderChart(lastPayload); }

      async function init(){
        try{
          const payload=await loadCounts();
          renderChart(payload);
        }catch(e){
          console.error("Error loading player counts:",e);
          alert("Failed to load player counts.");
        }
      }

      qs("timeRangeForm")?.addEventListener("submit",async(e)=>{
        e.preventDefault();
        const start=qs("start").value;
        const end=qs("end").value;
        try{
          const payload=await loadCounts({start,end});
          renderChart(payload);
        }catch(err){
          console.error("Error loading player counts for range:",err);
          alert("Failed to load for selected range.");
        }
      });

      qs("untickAllButton")?.addEventListener("click",()=>{
        qsa('input[name="datapoint"]').forEach(i=>i.checked=false);
        refreshFromSelections();
      });

      qsa('input[name="datapoint"]').forEach(i=>i.addEventListener("change",refreshFromSelections));

      init();
    </script>

  </body>
</html>
