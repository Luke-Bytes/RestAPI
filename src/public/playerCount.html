<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player Count Graph</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #121212;
        color: #e0e0e0;
        font-family: "Roboto", sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      .container {
        width: 90%;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }

      h1 {
        text-align: center;
        margin-bottom: 20px;
      }

      form {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        align-items: center;
      }

      form > div {
        display: flex;
        align-items: center;
      }

      label {
        margin-right: 5px;
        font-size: 1rem;
      }

      input[type="date"] {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 4px;
        padding: 8px;
        color: #e0e0e0;
      }

      input[type="date"]::placeholder {
        color: #999;
      }

      button {
        background-color: #1976d2;
        border: none;
        border-radius: 4px;
        padding: 10px 20px;
        font-size: 1rem;
        color: #fff;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #1565c0;
      }

      canvas {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 4px;
        display: block;
        width: 100%;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Player Count Graph</h1>

      <form id="timeRangeForm">
        <div>
          <label for="start">Start:</label>
          <input type="date" id="start" name="start" />
        </div>
        <div>
          <label for="end">End:</label>
          <input type="date" id="end" name="end" />
        </div>
        <div>
          <button type="submit">Load Data</button>
        </div>
      </form>

      <canvas id="playerCountChart"></canvas>
    </div>

    <script>
      const ctx = document.getElementById("playerCountChart").getContext("2d");
      let playerCountChart;

      async function loadData(start, end) {
        const params = new URLSearchParams();
        if (start) params.append("start", start);
        if (end) params.append("end", end);

        try {
          const response = await fetch(`/api/playerCount?${params.toString()}`);
          const data = await response.json();

          // Debug log: check what data is returned from the API
          console.log("Data fetched:", data);

          // Use the ISO timestamp directly for the x-axis labels.
          // Chart.js will handle parsing these dates using your date adapter.
          const labels = data.map((entry) => entry.timestamp);
          const counts = data.map((entry) => entry.all);

          // Warn if no data is returned
          if (data.length === 0) {
            console.warn("No data returned from the API.");
          }

          // If there's an existing chart instance, destroy it to free up the canvas.
          if (playerCountChart) {
            playerCountChart.destroy();
          }

          // Create a new chart instance.
          playerCountChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: labels, // these are ISO strings (e.g., "2025-02-15T12:34:56.789Z")
              datasets: [
                {
                  label: "Total Players",
                  data: counts,
                  borderColor: "rgba(25, 118, 210, 1)",
                  backgroundColor: "rgba(25, 118, 210, 0.2)",
                  fill: true,
                  tension: 0.1,
                  pointBackgroundColor: "#fff",
                  pointBorderColor: "rgba(25, 118, 210, 1)",
                },
              ],
            },
            options: {
              scales: {
                x: {
                  type: "time", // time scale uses the date adapter to parse timestamps
                  time: {
                    tooltipFormat: "ll HH:mm",
                    displayFormats: { hour: "MMM d, hA" },
                  },
                  title: { display: true, text: "Time", color: "#e0e0e0" },
                  ticks: { color: "#e0e0e0" },
                  grid: { color: "rgba(255, 255, 255, 0.1)" },
                },
                y: {
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: "Player Count",
                    color: "#e0e0e0",
                  },
                  ticks: { color: "#e0e0e0" },
                  grid: { color: "rgba(255, 255, 255, 0.1)" },
                },
              },
              plugins: {
                legend: {
                  labels: { color: "#e0e0e0" },
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      return context.dataset.label + ": " + context.parsed.y;
                    },
                  },
                },
              },
            },
          });
        } catch (error) {
          console.error("Error loading player counts:", error);
        }
      }

      document
        .getElementById("timeRangeForm")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const start = document.getElementById("start").value;
          const end = document.getElementById("end").value;
          loadData(start, end);
        });

      loadData();
    </script>
  </body>
</html>
